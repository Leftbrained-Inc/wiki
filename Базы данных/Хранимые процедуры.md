# Хранимые процедуры (функции)

> :book: **Хранимые процедуры** (далее ХП) — это объект базы данных, представляющий собой набор SQL-инструкций, который компилируется один раз на сервере. Она может быть вызвана при помощи триггеров, другой хранимой процедуры или из приложения.

### Плюсы

- **Помощь в увеличении производительности.** Процедуры компилируются и хранятся прямо в БД (кешируются).

- **Экономия трафика.** Вместо использования огромных конструкций SQL с условиями и значениями, для процедуры нужен лишь вызов со списком переменных - это существенно **ускоряет обмен трафиком**.

- **Много разовость и открытость для любого приложения**. Создаем процедуру лишь один раз - и можно достаточно просто переписывать клиентскую или серверную часть под любую другую платформу или даже использовать несколько одновременно, при этом все хранимые процедуры будут находиться на сервере БД.

- **Повышенная безопасность XП.** DBA (DataBase Administrator или Администратор Базы Данных) может ограничить использование процедур на отдельные приложения или открыть процедуру, но не давать доступа к исходным таблицам.

### Минусы

- Если вызывается множество XП, то **использование оперативной памяти на каждую сессию возрастет.** Если в процедуре есть много логических операций, то это существенно загрузит устройство, потому что сервер не разработан и не оптимизирован для таких операций.
    
- **Сложность разработки и поддержки.** Использование процедур подразумевает собой наличие определенного **багажа знаний** и специализированных знаний РСУБД[^1]. Это принесет существенные проблемы на стадиях разработки и поддержки ПО.

### Как сделать

Общий формат выглядит так:

```sql
CREATE PROCEDURE /* имя */ (/* список параметров */)
/* тело процедуры */;

/* или функция */
CREATE FUNCTION /* имя */ (/* список параметров */) 
[RETURNS /* тип значения, которое возвращает */]
тело функции;

-- Формат задания параметров: [IN | OUT | INOUT] {имя} {тип}.
```

А позже мы вызываем процедуру:

```sql
CALL /* имя */ (/* список параметров */);
```

#### :warning: Функция всегда должна возвращать значение - и только в ней пишется конструкция `returns`.

### Виды параметров

- :arrow_right: **IN** — режим по умолчанию. Когда он определен, то процедура использует значение, переданное как этот параметр. Значение, которое использует процедура - защищено.  Это означает, что каждое такое значение изменяется только внутри неё, то есть процедура работает **с внутренней копией**.

- :arrow_left: **OUT** — режим, когда значение возвращается. Это означает, что переменная, переданная в процедуру при вызове может быть изменена из процедуры и новое значение **сохранится во внешнем блоке**.

- :arrows_counterclockwise: **INOUT** — параметр садится на два стула - он и IN и OUT в одном.  Обычно его используют для передачи данных из одной функции в другую или из функции обратно в вызывающую ее программу.

[^1]: **РСУБД** (реляционная система управления базами данных) — это система для хранения и манипулирования базами данных. Она позволяет работать с данными, как с наборами таблиц, на которые можно применять различные операции, такие как: объединение, выборка, поиск, обновление и удаление. РСУБД обеспечивает безопасность данных, надежность и целостность.